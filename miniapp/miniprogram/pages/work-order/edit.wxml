<view class="edit-container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <text class="header-icon">âœï¸</text>
    <text class="header-title">ç¼–è¾‘å·¥å•</text>
  </view>

  <!-- åŸºæœ¬ä¿¡æ¯è¡¨å• -->
  <view class="form-card">
    <view class="card-title">
      <text class="title-icon">ğŸ“‹</text>
      <text class="title-text">åŸºæœ¬ä¿¡æ¯</text>
    </view>

    <!-- è½¦è¾†ä¿¡æ¯ -->
    <view class="form-group">
      <view class="label-row">
        <text class="label required">è½¦è¾†ä¿¡æ¯</text>
      </view>
      <input 
        class="input full-width" 
        placeholder="è¯·è¾“å…¥è½¦ç‰Œå·æˆ–è½¦è¾†å‹å·" 
        value="{{workOrder.vehicleInfo}}" 
        bindinput="onInput" 
        data-field="vehicleInfo"
        placeholder-style="color: #ccc;"
      />
    </view>

    <!-- è½¦ä¸» -->
    <view class="form-group">
      <view class="label-row">
        <text class="label required">è½¦ä¸»</text>
        <text class="char-count">{{workOrder.description ? workOrder.description.length : 0}}/500</text>
      </view>
      <textarea 
        class="textarea" 
        placeholder="è¯·å¡«å†™è½¦ä¸»åå­—" 
        value="{{workOrder.description}}" 
        bindinput="onInput" 
        data-field="description"
        maxlength="500"
        auto-height
        show-confirm-bar="{{false}}"
        placeholder-style="color: #ccc;"
      ></textarea>
    </view>
  </view>

  <!-- ç»´ä¿®é¡¹ç›®ç®¡ç†å¡ç‰‡ -->
  <view class="work-items-card">
    <view class="card-title">
      <text class="title-icon">ğŸ”§</text>
      <text class="title-text">ç»´ä¿®é¡¹ç›®</text>
      <text class="count-badge">{{workItems.length}}</text>
    </view>

    <!-- é¡¹ç›®åˆ—è¡¨ -->
    <view class="work-items-list" wx:if="{{workItems.length > 0}}">
      <view class="work-item" wx:for="{{workItems}}" wx:key="id">
        <view class="item-header">
          <view class="item-info">
            <text class="item-name">{{item.itemName}}</text>
            <text class="item-description" wx:if="{{item.description}}">{{item.description}}</text>
          </view>
          <view class="item-price">Â¥{{item.price}}</view>
        </view>
        <view class="item-actions">
          <button class="item-delete-btn" bindtap="deleteWorkItem" data-id="{{item.id}}">åˆ é™¤</button>
        </view>
      </view>
    </view>

    <!-- é¡¹ç›®æ€»è´¹ç”¨æ˜¾ç¤º -->
    <view class="items-summary">
      <text class="summary-label">é¡¹ç›®æ€»è´¹ç”¨ï¼š</text>
      <text class="summary-price">Â¥{{totalCost}}</text>
    </view>

    <!-- æ·»åŠ é¡¹ç›®æŒ‰é’® -->
    <button class="btn-add-item" bindtap="showWorkItemForm">
      <text class="btn-icon">+</text>
      <text>æ·»åŠ ç»´ä¿®é¡¹ç›®</text>
    </button>
  </view>

  <!-- å›¾ç‰‡ç®¡ç† -->
  <view class="images-card">
    <view class="card-title">
      <text class="title-icon">ğŸ“·</text>
      <text class="title-text">ç›¸å…³å›¾ç‰‡</text>
      <text class="image-count">({{images.length}}/9)</text>
    </view>

    <view class="image-grid">
      <!-- å·²ä¸Šä¼ çš„å›¾ç‰‡ -->
      <view class="image-item" wx:for="{{images}}" wx:key="id">
        <image class="image" src="{{item.url}}" mode="aspectFill" bindtap="previewImage" data-url="{{item.url}}" />
        <view class="delete-btn" bindtap="deleteImage" data-id="{{item.id}}">
          <text class="delete-icon">Ã—</text>
        </view>
      </view>

      <!-- ä¸Šä¼ æŒ‰é’® -->
      <view class="upload-btn" bindtap="chooseImage" wx:if="{{images.length < 9}}">
        <text class="upload-icon">+</text>
        <text class="upload-text">æ·»åŠ å›¾ç‰‡</text>
      </view>
    </view>

    <view class="upload-tip">æ”¯æŒä¸Šä¼ æœ€å¤š9å¼ å›¾ç‰‡ï¼Œç‚¹å‡»å›¾ç‰‡å¯é¢„è§ˆ</view>
  </view>

  <!-- âœ… ç¾åŒ–çš„æ´¾å·¥ç®¡ç†å¡ç‰‡ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰ -->
  <view class="assign-card" wx:if="{{userRole === 'admin'}}">
    <view class="card-title">
      <view class="title-left">
        <text class="title-icon">ğŸ‘¥</text>
        <text class="title-text">å·¥ä½œå›¢é˜Ÿ</text>
      </view>
      <text class="count-badge-new">{{assignedWorkers.length}}äºº</text>
    </view>

    <!-- å·²åˆ†é…çš„å‘˜å·¥åˆ—è¡¨ -->
    <view class="assigned-workers-grid" wx:if="{{assignedWorkers.length > 0}}">
      <view class="worker-card" wx:for="{{assignedWorkers}}" wx:key="id">
        <view class="worker-avatar">
          <text class="avatar-text">{{item.username.substr(0,1)}}</text>
        </view>
        <view class="worker-details">
          <text class="worker-name-main">{{item.username}}</text>
          <text class="worker-role-badge">{{item.workerRole || 'æœªæŒ‡å®š'}}</text>
        </view>
      </view>
    </view>

    <!-- æ— æ´¾å·¥æç¤º -->
    <view class="empty-assign-new" wx:else>
      <text class="empty-icon-new">ğŸ‘¤</text>
      <text class="empty-text-new">è¿˜æœªåˆ†é…å·¥ä½œäººå‘˜</text>
      <text class="empty-hint">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¿›è¡Œåˆ†é…</text>
    </view>

    <!-- åˆ†é…æŒ‰é’® -->
    <button class="btn-assign-new" bindtap="openAssignModal">
      <text class="btn-icon">{{assignedWorkers.length > 0 ? 'âœï¸' : 'â•'}}</text>
      <text>{{assignedWorkers.length > 0 ? 'ä¿®æ”¹åˆ†é…' : 'åˆ†é…å‘˜å·¥'}}</text>
    </button>
  </view>

  <!-- âœ… ç¾åŒ–çš„æ´¾å·¥å¼¹çª— -->
  <view class="modal-mask-new {{showAssignModal ? 'show' : ''}}" wx:if="{{showAssignModal}}" bindtap="closeAssignModal" catchtouchmove="preventTouchMove">
    <view class="modal-dialog-new" catchtap="doNothing">
      <!-- å¼¹çª—å¤´éƒ¨ -->
      <view class="modal-header-new">
        <view class="header-left">
          <text class="header-icon-new">ğŸ‘¥</text>
          <view class="header-text-group">
            <text class="header-title-new">é€‰æ‹©å·¥ä½œäººå‘˜</text>
            <text class="header-subtitle">ä¸ºå·¥å•åˆ†é…åˆé€‚çš„å‘˜å·¥</text>
          </view>
        </view>
        <view class="close-btn" bindtap="closeAssignModal">
          <text class="close-icon">âœ•</text>
        </view>
      </view>

      <!-- å¼¹çª—ä¸»ä½“ -->
      <scroll-view class="modal-body-new" scroll-y="true">
        <view class="workers-grid" wx:if="{{availableWorkers.length > 0}}">
          <view 
            class="worker-option-new {{selectedWorkers[item.id] ? 'selected' : ''}}" 
            wx:for="{{availableWorkers}}" 
            wx:key="id"
            bindtap="toggleWorker"
            data-id="{{item.id}}"
          >
            <!-- é€‰ä¸­æ ‡è¯† -->
            <view class="select-indicator {{selectedWorkers[item.id] ? 'active' : ''}}">
              <text class="check-icon" wx:if="{{selectedWorkers[item.id]}}">âœ“</text>
            </view>

            <!-- å‘˜å·¥å¤´åƒ -->
            <view class="worker-avatar-large">
              <text class="avatar-text-large">{{item.username.substr(0,1)}}</text>
            </view>

            <!-- å‘˜å·¥ä¿¡æ¯ -->
            <view class="worker-info-new">
              <text class="worker-name-new">{{item.username}}</text>
              <text class="worker-phone-new">{{item.phone}}</text>
            </view>

            <!-- å·¥ç§é€‰æ‹© -->
            <view class="role-select-area" wx:if="{{selectedWorkers[item.id]}}" catchtap="doNothing">
              <text class="role-label-new">å·¥ç§</text>
              <picker 
                class="role-picker" 
                mode="selector" 
                range="{{roleOptions}}"
                value="{{0}}"
                data-worker-id="{{item.id}}"
                bindchange="selectRole"
              >
                <view class="picker-display">
                  <text class="picker-text">{{selectedRoles[item.id] || 'è¯·é€‰æ‹©'}}</text>
                  <text class="picker-arrow">â–¼</text>
                </view>
              </picker>
            </view>
          </view>
        </view>

        <!-- ç©ºçŠ¶æ€ -->
        <view wx:else class="empty-workers-new">
          <text class="empty-icon-large">ğŸ‘¥</text>
          <text class="empty-text-large">æš‚æ— å¯ç”¨å‘˜å·¥</text>
          <text class="empty-hint-text">è¯·å…ˆæ·»åŠ å‘˜å·¥</text>
        </view>
      </scroll-view>

      <!-- å¼¹çª—åº•éƒ¨ -->
      <view class="modal-footer-new">
        <view class="selected-info" wx:if="{{selectedWorkerCount > 0}}">
          <text class="selected-text">å·²é€‰æ‹© {{selectedWorkerCount}} äºº</text>
        </view>
        <view class="footer-buttons">
          <button class="modal-btn-new cancel-new" bindtap="closeAssignModal">å–æ¶ˆ</button>
          <button 
            class="modal-btn-new confirm-new" 
            bindtap="confirmAssign" 
            disabled="{{assignLoading}}"
            loading="{{assignLoading}}"
          >
            ç¡®è®¤åˆ†é…
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-buttons">
    <button class="btn btn-cancel" bindtap="cancelEdit">
      <text>å–æ¶ˆ</text>
    </button>
    <button class="btn btn-save" bindtap="showSaveConfirm">
      <text class="btn-icon">ğŸ’¾</text>
      <text>ä¿å­˜ä¿®æ”¹</text>
    </button>
  </view>

  <!-- ä¿å­˜ç¡®è®¤å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showConfirm}}" bindtap="cancelConfirm">
    <view class="modal-dialog" catchtap="">
      <view class="modal-icon">ğŸ’¾</view>
      <view class="modal-title">ç¡®è®¤ä¿å­˜ä¿®æ”¹ï¼Ÿ</view>
      <view class="modal-content">
        <view class="confirm-item">
          <text class="confirm-label">è½¦è¾†ä¿¡æ¯</text>
          <text class="confirm-value">{{workOrder.vehicleInfo || 'æœªå¡«å†™'}}</text>
        </view>
        <view class="confirm-item">
          <text class="confirm-label">é—®é¢˜æè¿°</text>
          <text class="confirm-value" style="max-width: 300rpx; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{workOrder.description || 'æœªå¡«å†™'}}</text>
        </view>
        <view class="confirm-item">
          <text class="confirm-label">é¡¹ç›®æ€»è´¹ç”¨</text>
          <text class="confirm-value price">Â¥{{totalCost}}</text>
        </view>
      </view>
      <view class="modal-buttons">
        <button class="modal-btn cancel" bindtap="cancelConfirm">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="confirmSave">ç¡®è®¤ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- æ·»åŠ ç»´ä¿®é¡¹ç›®å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showWorkItemForm}}">
    <view class="modal-dialog work-item-form" bindtap="doNothing">
      <view class="modal-title">æ·»åŠ ç»´ä¿®é¡¹ç›®</view>
      
      <view class="form-group">
        <text class="label required">é¡¹ç›®åç§°</text>
        <input 
          class="input full-width"
          placeholder="å¦‚ï¼šæœºæ²¹æ›´æ¢ã€è½®èƒç»´ä¿®"
          value="{{newWorkItem.itemName}}"
          bindinput="onWorkItemInput"
          data-field="itemName"
          placeholder-style="color: #ccc;"
        />
      </view>

      <view class="form-group">
        <text class="label">æè¿°</text>
        <textarea
          class="textarea"
          placeholder="é¡¹ç›®æè¿°ï¼ˆå¯é€‰ï¼‰"
          value="{{newWorkItem.description}}"
          bindinput="onWorkItemInput"
          data-field="description"
          maxlength="200"
          placeholder-style="color: #ccc;"
        ></textarea>
      </view>

      <view class="form-group">
        <text class="label required">è´¹ç”¨</text>
        <view class="input-with-icon">
          <text class="currency-symbol">Â¥</text>
          <input
            class="input cost-input"
            type="digit"
            placeholder="è¯·è¾“å…¥é‡‘é¢"
            value="{{newWorkItem.price}}"
            bindinput="onWorkItemInput"
            data-field="price"
            placeholder-style="color: #ccc;"
          />
        </view>
      </view>

      <view class="modal-buttons">
        <button class="modal-btn cancel" bindtap="closeWorkItemForm">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="addWorkItem">æ·»åŠ </button>
      </view>
    </view>
  </view>
</view>


